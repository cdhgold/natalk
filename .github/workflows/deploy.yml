name: NaTalk Deploy to Naver Cloud

on:
  push:
    branches: [main] # 메인 브랜치에 푸시될 때 실행

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      # 1. Docker Hub 로그인
      - name: Login to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_TOKEN }}

      # 2. 이미지 빌드 및 푸시
      - name: Build and Push Docker Image
        run: |
          docker build -t ${{ secrets.DOCKER_USERNAME }}/vibe-talk:${{ github.sha }} .
          docker push ${{ secrets.DOCKER_USERNAME }}/vibe-talk:${{ github.sha }}

      # 3. 네이버 클라우드 서버에 접속해서 배포 (SSH)
      - name: Deploy to Naver Cloud
        uses: appleboy/ssh-action@v1.0.3 # master 브랜치 대신 특정 버전을 사용하는 것을 권장합니다.
        with:
          host: ${{ secrets.NAVER_CLOUD_HOST }}
          username: root  # 보통 네이버 클라우드는 root
          key: ${{ secrets.NAVER_CLOUD_SSH_KEY }}
          script: |
            # 배포 스크립트
            # 최신 이미지를 Docker Hub에서 가져옵니다.
            docker pull ${{ secrets.DOCKER_USERNAME }}/vibe-talk:${{ github.sha }}
            # 기존 컨테이너가 있으면 중지하고 삭제합니다.
            docker stop vibe-talk || true
            docker rm vibe-talk || true
            # 데이터 영속성을 위한 호스트 디렉토리를 생성합니다.
            mkdir -p /root/natalk-data
            # 새 버전으로 컨테이너를 실행합니다.
            # 호스트의 /root/natalk-data 디렉토리를 컨테이너의 /data 디렉토리에 연결합니다.
            docker run -d --name vibe-talk \
              --restart always \
              -p 3002:3002 \
              -v /root/natalk-data:/data \
              ${{ secrets.DOCKER_USERNAME }}/vibe-talk:${{ github.sha }}
            # 사용하지 않는 Docker 이미지 정리 (공간 확보)
            docker image prune -af